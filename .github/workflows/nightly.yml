name: Nightly E2E Tests

on:
  schedule:
    # Run at 6 AM UTC daily (10 PM PST / 1 AM EST)
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      test_filter:
        description: 'Specific test to run (e.g., tests/e2e/test_downloads.py::TestDownloadReport)'
        required: false
        default: ''

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  e2e:
    name: E2E Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    # Only run on main repo (not forks) due to secrets requirement
    if: github.repository == 'teng-lin/notebooklm-py'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.12"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[all]"

    - name: Get Playwright version
      id: playwright-version
      shell: bash
      run: |
        echo "version=$(pip show playwright | grep '^Version:' | cut -d' ' -f2)" >> $GITHUB_OUTPUT

    - name: Cache Playwright browsers
      uses: actions/cache@v5
      with:
        path: |
          ~/.cache/ms-playwright
          ~/AppData/Local/ms-playwright
        key: playwright-${{ matrix.os }}-${{ steps.playwright-version.outputs.version }}

    - name: Install Playwright browsers
      run: playwright install chromium

    - name: Install Playwright system dependencies (Linux)
      if: runner.os == 'Linux'
      run: playwright install-deps

    - name: Debug - Print notebook IDs
      shell: bash
      env:
        NOTEBOOKLM_READ_ONLY_NOTEBOOK_ID: ${{ secrets.NOTEBOOKLM_READ_ONLY_NOTEBOOK_ID }}
        NOTEBOOKLM_GENERATION_NOTEBOOK_ID: ${{ secrets.NOTEBOOKLM_GENERATION_NOTEBOOK_ID }}
      run: |
        echo "READ_ONLY_NOTEBOOK_ID: $NOTEBOOKLM_READ_ONLY_NOTEBOOK_ID"
        echo "GENERATION_NOTEBOOK_ID: $NOTEBOOKLM_GENERATION_NOTEBOOK_ID"
        echo "READ_ONLY length: ${#NOTEBOOKLM_READ_ONLY_NOTEBOOK_ID}"
        echo "GENERATION length: ${#NOTEBOOKLM_GENERATION_NOTEBOOK_ID}"

    - name: Debug - List artifacts in READ_ONLY notebook
      if: inputs.test_filter != ''
      env:
        NOTEBOOKLM_AUTH_JSON: ${{ secrets.NOTEBOOKLM_AUTH_JSON }}
        NOTEBOOKLM_READ_ONLY_NOTEBOOK_ID: ${{ secrets.NOTEBOOKLM_READ_ONLY_NOTEBOOK_ID }}
      shell: bash
      run: |
        python3 << 'EOF'
        import asyncio
        import os
        from notebooklm import NotebookLMClient

        async def main():
            nb_id = os.environ.get("NOTEBOOKLM_READ_ONLY_NOTEBOOK_ID")
            if not nb_id:
                print("ERROR: NOTEBOOKLM_READ_ONLY_NOTEBOOK_ID not set")
                return

            print(f"Checking notebook: {nb_id}")
            async with await NotebookLMClient.from_storage() as client:
                raw = await client.artifacts._list_raw(nb_id)
                print(f"Total raw artifacts: {len(raw)}")

                for i, a in enumerate(raw):
                    if isinstance(a, list) and len(a) > 4:
                        art_type = a[2]
                        status = a[4]
                        title = a[1] if len(a) > 1 else "?"
                        length = len(a)
                        type_names = {1: "AUDIO", 2: "REPORT", 3: "VIDEO", 4: "QUIZ/FLASH",
                                      5: "MIND_MAP", 7: "INFOGRAPHIC", 8: "SLIDE_DECK", 9: "DATA_TABLE"}
                        type_name = type_names.get(art_type, f"TYPE_{art_type}")
                        status_name = {1: "PROCESSING", 2: "PENDING", 3: "COMPLETED"}.get(status, f"STATUS_{status}")
                        print(f"  [{i}] {type_name} | {status_name} | len={length} | {title[:50]}")

                        # Extra detail for reports
                        if art_type == 2:
                            has_content = len(a) > 7 and a[7] is not None
                            print(f"       â†’ len>7: {length > 7}, status==3: {status == 3}, has_content: {has_content}")

        asyncio.run(main())
        EOF

    - name: Run E2E tests
      env:
        NOTEBOOKLM_AUTH_JSON: ${{ secrets.NOTEBOOKLM_AUTH_JSON }}
        NOTEBOOKLM_READ_ONLY_NOTEBOOK_ID: ${{ secrets.NOTEBOOKLM_READ_ONLY_NOTEBOOK_ID }}
        NOTEBOOKLM_GENERATION_NOTEBOOK_ID: ${{ secrets.NOTEBOOKLM_GENERATION_NOTEBOOK_ID }}
      shell: bash
      run: |
        TEST_FILTER="${{ inputs.test_filter }}"
        if [ -n "$TEST_FILTER" ]; then
          # Run specific test(s) when filter provided
          pytest "$TEST_FILTER" -s -v --tb=short --reruns 2 --reruns-delay 30
        elif [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          # Linux: run all E2E tests except variants
          pytest tests/e2e -m "not variants" -s -v --tb=short --reruns 2 --reruns-delay 30
        else
          # Windows: run only read-only tests (safer, avoids write operations)
          pytest tests/e2e -m "readonly and not variants" -s -v --tb=short --reruns 2 --reruns-delay 30
        fi
